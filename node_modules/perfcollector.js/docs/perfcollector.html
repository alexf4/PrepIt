<!DOCTYPE html>

<html>
<head>
  <title>perfcollector.js</title>
  <meta http-equiv="content-type" content="text/html; charset=UTF-8">
  <meta name="viewport" content="width=device-width, target-densitydpi=160dpi, initial-scale=1.0; maximum-scale=1.0; user-scalable=0;">
  <link rel="stylesheet" media="all" href="docco.css" />
</head>
<body>
  <div id="container">
    <div id="background"></div>
    
    <ul class="sections">
        
          <li id="title">
              <div class="annotation">
                  <h1>perfcollector.js</h1>
              </div>
          </li>
        
        
        
        <li id="section-1">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-1">&#182;</a>
              </div>
              <pre><code>perfcollector.js

(c) 2013, Jean-Christophe Hoelt, Fovea.cc
perfcollector may be freely distributed under the MIT license.
For all details and documentation:
https://github.com/Fovea/perfcollector.js</code></pre>

            </div>
            
            <div class="content"><div class='highlight'><pre>(<span class="function"><span class="keyword">function</span> <span class="params">()</span> {</span>
    <span class="string">'use strict'</span>;</pre></div></div>
            
        </li>
        
        
        <li id="section-2">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-2">&#182;</a>
              </div>
              <p>Save a reference to the global object (<code>window</code> in the browser, <code>exports</code>
on the server).</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="keyword">var</span> root = <span class="keyword">this</span>;</pre></div></div>
            
        </li>
        
        
        <li id="section-3">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-3">&#182;</a>
              </div>
              <p>The top-level namespace. All public methods will
be attached to this. Exported for both the browser and the server.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="keyword">var</span> PerfCollector;
    <span class="keyword">if</span> (<span class="keyword">typeof</span> exports !== <span class="string">'undefined'</span>) {
        PerfCollector = exports;
    } <span class="keyword">else</span> {
        PerfCollector = root.PerfCollector = {};
    }</pre></div></div>
            
        </li>
        
        
        <li id="section-4">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-4">&#182;</a>
              </div>
              <p>Retrieve the highest-precision time counter.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="keyword">var</span> performance = root.performance || {};</pre></div></div>
            
        </li>
        
        
        <li id="section-5">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-5">&#182;</a>
              </div>
              <p>For node, use process.hrtime is available</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="keyword">if</span> (root.process &amp;&amp; root.process.hrtime) {
        performance.now = <span class="function"><span class="keyword">function</span> <span class="params">()</span> {</span>
            <span class="keyword">var</span> t = process.hrtime();
            <span class="keyword">return</span> t[<span class="number">0</span>] * <span class="number">1000</span> + t[<span class="number">1</span>] / <span class="number">1000000</span>;
        };
    }</pre></div></div>
            
        </li>
        
        
        <li id="section-6">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-6">&#182;</a>
              </div>
              <p>For browsers, use performance.now or Date.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="keyword">else</span> {
        performance.now = (<span class="keyword">function</span>() {
            <span class="keyword">return</span> performance.now       ||
                performance.mozNow    ||
                performance.msNow     ||
                performance.oNow      ||
                performance.webkitNow ||
                <span class="keyword">function</span>() { <span class="keyword">return</span> <span class="keyword">new</span> Date().getTime(); };
            })();
    }</pre></div></div>
            
        </li>
        
        
        <li id="section-7">
            <div class="annotation">
              
              <div class="pilwrap for-h2">
                <a class="pilcrow" href="#section-7">&#182;</a>
              </div>
              <h2>perfcollector</h2>

            </div>
            
        </li>
        
        
        <li id="section-8">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-8">&#182;</a>
              </div>
              <p>Allows you to profile time to perform certain actions
Used by the Router to profile view creation times.</p>
<p>Set Jackbone.profile.enabled = true to activate.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="keyword">var</span> Klass = <span class="function"><span class="keyword">function</span> <span class="params">()</span> {</span></pre></div></div>
            
        </li>
        
        
        <li id="section-9">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-9">&#182;</a>
              </div>
              <p>Set to true to enable profiling your views.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        <span class="keyword">this</span>.enabled = <span class="literal">false</span>;</pre></div></div>
            
        </li>
        
        
        <li id="section-10">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-10">&#182;</a>
              </div>
              <p>Dictionary of statistics</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        <span class="keyword">this</span>.stats = {};</pre></div></div>
            
        </li>
        
        
        <li id="section-11">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-11">&#182;</a>
              </div>
              <p>Currently running timers</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        <span class="keyword">this</span>._timersByName = {};
    };

    Klass.prototype.enable = <span class="function"><span class="keyword">function</span> <span class="params">(status)</span> {</span>
        <span class="keyword">if</span> (status !== <span class="literal">false</span>)
            status = <span class="literal">true</span>;
        <span class="keyword">this</span>.enabled = status;
        <span class="keyword">return</span> <span class="keyword">this</span>;
    };

    Klass.prototype.disable = <span class="function"><span class="keyword">function</span> <span class="params">()</span> {</span>
        <span class="keyword">this</span>.enabled = <span class="literal">false</span>;
        <span class="keyword">return</span> <span class="keyword">this</span>;
    };

    <span class="keyword">var</span> timerStart = <span class="function"><span class="keyword">function</span> <span class="params">(t)</span> {</span></pre></div></div>
            
        </li>
        
        
        <li id="section-12">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-12">&#182;</a>
              </div>
              <p>Start over an already used timer.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        <span class="keyword">this</span>.startDate = t || performance.now();
        <span class="keyword">return</span> <span class="keyword">this</span>;
    };
    <span class="keyword">var</span> timerEnd = <span class="function"><span class="keyword">function</span> <span class="params">(t, timerName)</span> {</span>
        <span class="keyword">this</span>.klass.end(<span class="keyword">this</span>, t, timerName);
        <span class="keyword">return</span> <span class="keyword">this</span>;
    };
    <span class="keyword">var</span> timerStats = <span class="function"><span class="keyword">function</span> <span class="params">()</span> {</span>
        <span class="keyword">return</span> <span class="keyword">this</span>.klass.stats[<span class="keyword">this</span>.name] || {
            calls: <span class="number">0</span>,
            totalMs: <span class="number">0</span>,
            averageMs: <span class="number">0</span>,
            maxMs: <span class="number">0</span>,
            lastMs: <span class="number">0</span>
        };
    };
    <span class="keyword">var</span> timerLogToConsole = <span class="function"><span class="keyword">function</span> <span class="params">()</span> {</span>
        <span class="keyword">var</span> stat = timerStats.call(<span class="keyword">this</span>);
        <span class="keyword">if</span> (stat) {
            console.log(<span class="keyword">this</span>.name + <span class="string">': '</span> + stat.calls + <span class="string">' calls, total: '</span> + stat.totalMs + <span class="string">'ms, avg:'</span> + stat.averageMs + <span class="string">'ms, max:'</span> + stat.maxMs + <span class="string">'ms'</span>);
        }
        <span class="keyword">return</span> <span class="keyword">this</span>;
    };</pre></div></div>
            
        </li>
        
        
        <li id="section-13">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-13">&#182;</a>
              </div>
              <p>Called at the beggining of an operation</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    Klass.prototype.start = Klass.prototype.timer = <span class="function"><span class="keyword">function</span> <span class="params">(t, timerName)</span> {</span>
        <span class="keyword">var</span> startDate;
        <span class="keyword">var</span> timer = {};

        <span class="keyword">if</span> (<span class="keyword">this</span>.enabled) {
            <span class="keyword">if</span> (<span class="keyword">typeof</span> t === <span class="string">'string'</span>) {
                timerName = t;
                t = <span class="literal">undefined</span>;
            }
            <span class="keyword">if</span> (timerName) {
                <span class="keyword">if</span> (!<span class="keyword">this</span>._timersByName[timerName]) {
                    <span class="keyword">if</span> (console.profile) {
                        console.profile(timerName);
                    }
                    <span class="keyword">this</span>._timersByName[timerName] = timer;
                }
            }

            timer.startDate = t || performance.now();
        }

        timer.klass = <span class="keyword">this</span>;
        timer.name = timerName;
        timer.end = timerEnd;
        timer.stats = timerStats;
        timer.logToConsole = timerLogToConsole;
        timer.start = timerStart;

        <span class="keyword">return</span> timer;
    };</pre></div></div>
            
        </li>
        
        
        <li id="section-14">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-14">&#182;</a>
              </div>
              <p>Called when an operation is done.</p>
<p>Will update Jackbone.profiler.stats and show average duration on the
console.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    Klass.prototype.end = <span class="function"><span class="keyword">function</span> <span class="params">(timer, t, timerName)</span> {</span>

        <span class="keyword">if</span> (<span class="keyword">this</span>.enabled) {
            <span class="keyword">if</span> (<span class="keyword">typeof</span> timer === <span class="string">'string'</span>) {
                timerName = timer;
                timer = <span class="keyword">this</span>._timersByName[timer];
            }

            <span class="keyword">if</span> (timer &amp;&amp; <span class="keyword">typeof</span> timer.startDate !== <span class="string">'undefined'</span>) {

                <span class="keyword">if</span> (<span class="keyword">typeof</span> t === <span class="string">'string'</span>) {
                    timerName = t;
                    t = <span class="literal">undefined</span>;
                }

                <span class="keyword">var</span> now = (t || performance.now());
                <span class="keyword">var</span> duration = now - timer.startDate;

                <span class="keyword">var</span> originalName = timer.name;
                <span class="keyword">if</span> (originalName) {
                    <span class="keyword">if</span> (<span class="keyword">this</span>._timersByName[originalName]) {
                        <span class="keyword">delete</span> <span class="keyword">this</span>._timersByName[originalName];
                        <span class="keyword">if</span> (console.profile) {
                            console.profileEnd(originalName);
                        }
                    }
                    <span class="keyword">if</span> (!timerName) {
                        timerName = originalName;
                    }
                }</pre></div></div>
            
        </li>
        
        
        <li id="section-15">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-15">&#182;</a>
              </div>
              <p>Already have stats for this method? Update them.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>                <span class="keyword">if</span> (<span class="keyword">typeof</span> <span class="keyword">this</span>.stats[timerName] !== <span class="string">'undefined'</span>) {
                    <span class="keyword">var</span> stats = <span class="keyword">this</span>.stats[timerName];
                    stats.calls += <span class="number">1</span>;
                    stats.totalMs += duration;
                    <span class="keyword">if</span> (duration &gt; stats.maxMs) {
                        stats.maxMs = duration;
                    }
                    stats.averageMs = stats.totalMs / stats.calls;
                    stats.lastMs = duration;
                }
                <span class="keyword">else</span> {</pre></div></div>
            
        </li>
        
        
        <li id="section-16">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-16">&#182;</a>
              </div>
              <p>It&#39;s the first time we profile this method, create the
initial stats.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>                    <span class="keyword">this</span>.stats[timerName] = {
                        calls: <span class="number">1</span>,
                        totalMs: duration,
                        maxMs: duration,
                        averageMs: duration,
                        lastMs: duration
                    };
                }</pre></div></div>
            
        </li>
        
        
        <li id="section-17">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-17">&#182;</a>
              </div>
              <p>console.log(&#39;time[&#39; + timerName + &#39;] = &#39; + duration + &#39;ms&#39;);</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>                timer.startDate = <span class="literal">undefined</span>;
                timer.name = timerName;</pre></div></div>
            
        </li>
        
        
        <li id="section-18">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-18">&#182;</a>
              </div>
              <p>return timer;</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>            }
            <span class="keyword">else</span> {
                <span class="keyword">if</span> (!timer) {
                    console.warn(<span class="string">'PerfCollector: Invalid timer'</span>);
                }
                <span class="keyword">else</span> {
                    console.warn(<span class="string">'PerfCollector: Timer already ended'</span>);</pre></div></div>
            
        </li>
        
        
        <li id="section-19">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-19">&#182;</a>
              </div>
              <p>return timer;</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>                }
            }
        }

        <span class="keyword">return</span> <span class="keyword">this</span>;
    };</pre></div></div>
            
        </li>
        
        
        <li id="section-20">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-20">&#182;</a>
              </div>
              <p>Run through the stats, display on the console.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    Klass.prototype.logToConsole = <span class="function"><span class="keyword">function</span> <span class="params">()</span> {</span>
        <span class="keyword">for</span> (<span class="keyword">var</span> name <span class="keyword">in</span> <span class="keyword">this</span>.stats) {
            <span class="keyword">var</span> stat = <span class="keyword">this</span>.stats[name];
            console.log(<span class="string">' - '</span> + name + <span class="string">': '</span> + stat.calls + <span class="string">' calls, total: '</span> + stat.totalMs + <span class="string">'ms, avg:'</span> + stat.averageMs + <span class="string">'ms, max:'</span> + stat.maxMs + <span class="string">'ms'</span>);
        }
    };</pre></div></div>
            
        </li>
        
        
        <li id="section-21">
            <div class="annotation">
              
              <div class="pilwrap for-h2">
                <a class="pilcrow" href="#section-21">&#182;</a>
              </div>
              <h2>Our public API</h2>

            </div>
            
        </li>
        
        
        <li id="section-22">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-22">&#182;</a>
              </div>
              <p>Library version</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    PerfCollector.VERSION = <span class="string">'0.8.0'</span>;</pre></div></div>
            
        </li>
        
        
        <li id="section-23">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-23">&#182;</a>
              </div>
              <p>Create a new perf collector</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    PerfCollector.create = <span class="function"><span class="keyword">function</span> <span class="params">()</span> {</span>
        <span class="keyword">return</span> <span class="keyword">new</span> Klass();
    };

    PerfCollector.now = <span class="function"><span class="keyword">function</span> <span class="params">()</span> {</span>
        <span class="keyword">return</span> performance.now();
    };

    <span class="keyword">return</span> PerfCollector;

}).call(<span class="keyword">this</span>);</pre></div></div>
            
        </li>
        
    </ul>
  </div>
</body>
</html>
